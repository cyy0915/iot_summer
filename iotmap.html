<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <script src='https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js'></script>
    <script src='https://cdn.bootcss.com/d3/5.15.1/d3.min.js'></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>

    <script>
        $(document).ready(function () {
            function lineShow(d) {
                d3.select('#select').attr('visibility', 'hidden').attr('id', 'noselect');
                d3.select(`.${d['省份']}`).attr('visibility', 'visible').attr('id', 'select');
            }
            function lineHide(d) {
                //d3.select(`.${d['省份']}`).attr('visibility', 'hidden')
            }

            var map = L
                .map('graph1')
                .setView([30, 120], 5);   // center position + zoom

// Add a tile to the map = a background. Comes from OpenStreetmap
            L.tileLayer(
                'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
                    maxZoom: 6,
                }).addTo(map);

// Add a svg layer to the map
            L.svg().addTo(map);

// Create data for circles:
            var Data = $.ajax({ url: 'plantLocation.csv', async: false });
            Data = Data.responseText;
            Data = d3.csvParse(Data);

            /*var tmp = [];
            for (var i = 0; i < 100; i++){
                var ran = Math.floor(Math.random() * Data.length);
                tmp.push(Data.splice(ran, 1)[0]);
            }
            Data = tmp;*/

            for (var i in Data){
                if (Data[i]['类型']==='核电'){
                    var tmp = Data[i].long;
                    Data[i].long = Data[i].lat;
                    Data[i].lat = tmp;
                }
            }
            var markers = Data;
            var province = d3.map(Data, d=>d['省份']).keys();
            var provinceLocation = {};
            for (var i in province){
                for (var j in Data){
                    if (Data[j]['省份']===province[i]){
                        provinceLocation[province[i]]=Data[j];
                    }
                }
            }

// Select the svg area and add circles:
            d3.select("#graph1").select("svg").attr('pointer-events', 'all').style('z-index', '999').style('cursor', 'default');
            d3.select("#graph1")
                .select("svg")
                .append('g').attr('class', 'circle')
                .selectAll("myCircles")
                .data(markers)
                .enter()
                .append("circle")
                .attr("cx", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).x })
                .attr("cy", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).y })
                .attr("r", 5)
                .style("fill", "red")
                .attr("fill-opacity", .4)

            d3.select("#graph1")
                .select("svg")
                .append('g').attr('class', 'clickcircle')
                .selectAll("myCircles")
                .data(markers)
                .enter()
                .append("circle")
                .attr("cx", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).x })
                .attr("cy", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).y })
                .attr("r", 20)
                .style("fill", "none")
                .on("mouseover", lineShow)
                .on("mouseout", lineHide);

            d3.select("#graph1")
                .select("svg")
                .append('g').attr('class', 'line')
                .selectAll('g')
                .data(province)
                .join('g').attr('class', d=>d).attr('visibility', 'hidden')
                .selectAll('line')
                .data(function (d) {
                    var partData = [];
                    for (var i in markers){
                        if (markers[i]['省份']===d){
                            partData.push(markers[i]);
                        }
                    }
                    return partData;
                })
                .join('line')
                .attr('x1', d=>map.latLngToLayerPoint([d.lat, d.long]).x).attr('y1', d=>map.latLngToLayerPoint([d.lat, d.long]).y)
                .attr('x2', function (d) {
                    var loc = provinceLocation[d['省份']];
                    return map.latLngToLayerPoint([loc.lat, loc.long]).x;
                })
                .attr('y2', function (d) {
                    var loc = provinceLocation[d['省份']];
                    return map.latLngToLayerPoint([loc.lat, loc.long]).y;
                })
                .attr('stroke', 'steelblue').attr('stroke-width', '1px').attr('opacity', '60%');
            for (var i in provinceLocation){
                if (i==='北京市'){
                    var center = provinceLocation[i];
                }
            }
            d3.select("#graph1")
                .select("svg")
                .append('g').attr('class', 'centerLine')
                .selectAll('line')
                .data(d3.entries(provinceLocation))
                .join('line')
                .attr('x1', d=>map.latLngToLayerPoint([d['value'].lat, d['value'].long]).x).attr('y1', d=>map.latLngToLayerPoint([d['value'].lat, d['value'].long]).y)
                .attr('x2', d=>map.latLngToLayerPoint([center.lat, center.long]).x).attr('y2', d=>map.latLngToLayerPoint([center.lat, center.long]).y)
                .attr('stroke', 'steelblue').attr('stroke-width', '2px').attr('opacity', '60%');
// Function that update circle position if something change
            function update() {
                d3.select('#graph1')
                    .selectAll("circle")
                    .attr("cx", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).x })
                    .attr("cy", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).y })
                d3.select('#graph1').select('.line')
                    .selectAll('line')
                    .attr('x1', d=>map.latLngToLayerPoint([d.lat, d.long]).x).attr('y1', d=>map.latLngToLayerPoint([d.lat, d.long]).y)
                    .attr('x2', function (d) {
                        var loc = provinceLocation[d['省份']];
                        return map.latLngToLayerPoint([loc.lat, loc.long]).x;
                    })
                    .attr('y2', function (d) {
                        var loc = provinceLocation[d['省份']];
                        return map.latLngToLayerPoint([loc.lat, loc.long]).y;
                    });
                d3.select('#graph1')
                    .select('.centerLine')
                    .selectAll('line')
                    .attr('x1', d=>map.latLngToLayerPoint([d['value'].lat, d['value'].long]).x).attr('y1', d=>map.latLngToLayerPoint([d['value'].lat, d['value'].long]).y)
                    .attr('x2', d=>map.latLngToLayerPoint([center.lat, center.long]).x).attr('y2', d=>map.latLngToLayerPoint([center.lat, center.long]).y)
            }

// If the user change the map (zoom or drag), I update circle position:
            map.on("moveend", update)


            var Data = $.ajax({ url: 'plantLocation.csv', async: false });
            Data = Data.responseText;
            Data = d3.csvParse(Data);
        })
    </script>
</head>
<body>
<div id="graph1" style="z-index: 300; width: 1500px; height: 1000px"></div>
</body>
</html>